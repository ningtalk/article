
## 定义
数据库事务是数据库管理系统执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。事务可以由一条简单的sql语句组成，也可以由一组复杂的sql组成。在事务中的操作，要么全部成功，要么什么都不做。  
在MySQL中，事务支持是在引擎层实现，MySQL是支持多引擎的数据库，并不是所有引擎都支持事务，比如MyISAM就不支持事务,InnoDB是支持事务的。
## 作用
* 为数据库操作序列提供了一个从失败中恢复到正常状态的方法，同时提供了数据库即使在异常状态下仍能保持一致性的方法
* 当多个应用在并发访问数据库时，可以在这些应用间提供一个隔离方法，以防彼此操作相互干扰

## 特性
ACID  
* 原子性 Atomicity：整个数据库事务是不可分割的工作单位，事务中的所有操作要么全部执行成功，要么失败一条都不执行（回滚或撤销）
* 一致性 Consistency：将数据库从一种状态转变为下一种一致的状态，即事务执行的前后，数据库的完整性约束没有被破坏
* 隔离性 Isolation：每个事务的对象对其他事务的操作对象相互隔离，即一个事务提交前对其他事务都不可见，通常用锁实现
* 持久性 Durability：事务一旦提交，其结果就是永久性的

## 分类
* 扁平事务
* 带有保存点的扁平事务
* 链事务
* 嵌套事务
* 分布式事务

### 扁平事务
使用最频繁的事务，所有操作都在同一层级，其间的操作是原子性的，要么都执行，要么都回滚，不能回滚操作的某一部分。

### 分布式事务
分布式环境下运行的扁平事务。
例如：持卡人通过ATM从银行卡a转账到银行卡b（a，b是不同的银行发行的卡）100元，在这种情况下的步骤为：  
* 1、ATM发出转账命令
* 2、从银行a的数据库中对卡的余额减去100
* 3、給银行b的数据库中对卡的月加上100
* 4、ATM反馈结果給用户，是转账成功或失败
整个过程不是在同一个数据节点上完成的操作，上面的2 3中任何一步操作失败，都会导致整个分布式事务回滚。  
InnoDB存储引擎提供来对XA事务的支持，并通过XA事务来支持分布式事务的实现。分布式事务是允许多个独立的事务资源（关系型数据库）参与到一个全局的事务中。  
XA事务由一个或多个资源管理器、一个事务管理器、一个应用程序组成。  
* 资源管理器：通常一个数据库就是一个资源管理器
* 事务管理器：协调参与全局事务中的各个事务
* 应用程序：定义事务的边界，指定全局事务事务的操作

分布式事务使用两阶段提交的方式：
* 第一阶段：所有参与全局事务的节点都开始准备，告诉事务管理器准备号提交了
* 第二阶段：事务管理器告诉资源管理器执行rollback还是commit，任何节点显示不能提交，则所有阶段都被告知回滚

## 事务的实现
事务的隔离性是由锁来实现。  
原子性、一致性、持久性是由redo log和undo log来完成。redo log来保证原子性和持久性，undo log来保证一致性。  


## 隔离级别
* read uncommitted 读未提交:一个事务还没提交时，其做的变更就能被其他事务所看到
* read committed 读提交：一个事务在提交之后，其做的变更才能被其他事务所看到
* repeatable read 可重复读：一个事务在执行中看到的数据，总是跟这个事务启动时看到的数据是一致的
* serializable 串行化：对于同一行数据，一个事务写入时需要加写锁，读取时需要加读锁

mysql innodb存储引擎的默认的隔离级别是可重复读，oracle数据库默认的隔离级别是读提交。  
可重复读没有幻读保护，innodb存储引擎使用Next-Key Lock锁的算法可以避免幻读的产生


## 使用
在MySQL命令行的默认设置下，事务都是自动提交（auto commit）的，即执行sql语句后会马上执行commit操作。显示的事务启动方式有两种：
* 显式启动事务语句，begin或start transaction,配套的提交语句是commit，回滚是rollback
* set autocommit=0，这个语句意味自动提交已关闭，如果你执行一个select语句，这个事务就启动了，而且不会自动提交，这个事务持续存在直到你主动执行 commit 或 rollback 语句，或者断开连接
